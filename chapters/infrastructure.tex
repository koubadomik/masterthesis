\chapter{Infrastucture and data collection}
First phase of our work is about running chosen sandbox to capture sigificant number of analysis results for further use. This task could be divided into two subtask - building infrastructure and data collection. Due to the fact that we would like to collect more than $50 000$ samples and usual analysis take $5$ minutes we will need more than one active instance so the distribution is another challenge.

We will describe the data collection process in detail. Downloaded malicious samples are our input and dynamic malware analysis is our output. Our pipeline could be seen on the figure \todo{add reference}

TODO: create image of pipeline 

\section{Samples}
Possible sources
Chosen source
- recommendation from team member
- description of Abuse.ch
- possible problems - bias?, Emotet results?, Some statistic from the report from VT which I downloaded (nice-to-have), maybe could be quite interesting to retrive list of file extentions - histogram?
Appendix: scraper script from abuse.ch
\section{Sample filtering}
Principle of detecting PE files - my way (reference file command,...)
Mention even that some files are zipped and we decompressed them and added results between our samples
Mention from some book how we can do this - I saw it in static analysis

\section{Static analysis}
VT, Metadefender and abuse reports, mention academic access for VT so we end up with that only

There is some useful info in this data. But nothing totally awesome. But good enough for pre-sorting.
Interesting are:

Abuse.CH:
- First seen: Us the oldest date to estimate how old the sample is. We need that for time scales
- ssdeep: Fuzzy hash, good to find similar samples
- sha256: Most common hash to link them together
- md5/.../other hashes: Sometimes used in articles. Keep them for reference

Metadefender:
Multi-scanner. Be aware to check which Av detected it. Only use the top 10 (check out av-comparatives or av-test)
Creation date is important. If the sample is older the AVs had some time to add detection (older: Time between first seen and detection)


Virustotal:
Similar to metadefender. Plus: It has update time of engine.
The other data in here:
- Packers: Malware can be packed. A nice hint, if available
- Import list: Used DLL functions. Some malware is loading external functionality during runtime....
- Resources: Attached malware parts (encrypted => high entropy). Maybe also abusing Icons of well known tools (=> trojans)
- Signature: Could be helpful to weed cleanstuff our. If it is properly signed by a authority we can trust....
If we want to classify malware as the first AV vendor seeing it, we can not use the detections others have on it. Obviously.
HTH
Thorsten

\section{Dynamic analysis}
\section{CapeV2 sandbox}
history (cuckoo)
description
    features...
configuration
sandbox architecture - dll monitor injection to malware process...
https://github.com/kevoreilly/CAPEv2

\subsection{Virtualization}
Downloaded images from organization sources (CTU in Prague)
Remote control, automatic setup (ansible, basic security,...), everything was intended to be scripted
VMS and their setup against detection
Mention two posibilities
    - kvm and doomdraven's script
    - vbox and vmcloak
        Experienced issued - old projects, not so effective like the kvm solution
their overall setup - to see as it is normal PC
    - Vmcloak
    ○ Virtualenvironment for lower version of python than pip installed and used thair steps
    ○ https://yrck.nl/posts/cuckoo-install.html
    - Sample files downloaded form the internet, names randomized (downloaded script, maybe I can try to write own, to have more likely names)
    - Software
    ○ Chrome
    ○ Firefox
    ○ (No Edge - not able to connect to internet error :D)
    ○ Adobe reader
    ○ Spotify
    ○ Gimp
    ○ VLC
    ○ WinRAR
    ○ Skype
    ○ Putty
    - private.ppk in Users/Administrator/.ssh generated by puttygen
    - One password in chrome database
\subsection{Network setup}
figure of the setup, description, argumentation
similar projects (isolation of malware network having internet access)
two branches - no internet, internet
internet
    describe in detail
    firewall
    security resoning
    syslog...
safe network made our work easier, mention couple of further ideas mentioned by Josef (thank to Josef at the beginning of thesis!)
\subsection{Sample distribution}
Reference scripts and crons..., sample storage
problems using provided distribution (concretize some, extract from notes, poor docs,..)
using nas storage and so on...

\section{Problems}
sandbox not running, firewall,...

\section{Results of analysis}
Description what everything we have at the end for every single sample, size of dataset (GB and number of samples)...
Try to compare to another public dataset with the attributes and mention that using this way is quite universal
What we have X what the docs says (caused our misconfiguration...) - https://cuckoo.readthedocs.io/en/latest/usage/results/ (reference cuckoo book)

\section{Used technology stack for data collection}
Ubuntu 20.04
CapeV2
VirtualBox, KVM
Python 3
Ansible - mention that everything should be scripted from the beginning



here will be less references so add references to documentations and so...

add literally every detail including some scripts to appendix, even configuration of network, vpn, reference manuals, security reasoning during setting up internet connection (see notes)...
Go through the scripts here https://github.com/koubadomik/master-thesis if I did not miss something

 


Previous connection
- Follow up analysis chapter and summarize what we did
Next connection
- At the end should be described output of sandbox and at the beggining of next chapter should be stated what we have chosen and why



- Realization of chapter 'data'
- our infrastructure - distribution, other types of analyses, network infrastructure (marginally, I am not going to use those data, I think, but I performed it and I can write about the risks and so on...)
- used tools
- distrbution
- pipeline
- run
- results
- Conclusions, comming-outs, summary, discussion