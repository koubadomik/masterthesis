\chapter{Introduction} \label{chap:intro}
\section*{Motivation}
In this day and age, we face an intense explosion of machine learning applications in various branches of human efforts such as biology, chemistry, physics, and others. These technologies widely influence our daily life and can make it immensely more convenient, faster and more enjoyable. On the other hand, there are a lot of cases where algorithms (especially in machine learning) can control our decisions, reasoning, and life.

If we use these computer science tools appropriately, we can often create something that may serve our protection. We can take the detection of threats and frauds in cybersecurity as a perfect example, reasearch and applications in this particular field are fascinating for multiple of reasons, and one of them being our motivation. We have to know which side we are standing on and what the interests of our clients are. In the case of fraud detection, we know that the investment is profitable only if the fraud has a significant financial impact. Not all frauds are interesting from a financial point of view because solving them also costs a lot of money. However, from the ethical point of view, every fraud should be punished. 

Similarly, network security, single device security, and access control are often disregarded. Small businesses targetting a specific market are not interested in costly services whose impact is mainly a preventive one considering their primary role is cost reduction and financial profit. Nevertheless, it cannot be denied that loss of privacy and data is undesirable. It is impossible though, to achive both. We have to start with an analysis of costs, benefits, risks, probability, and impact (potential damage). That is not so evident in a technical branch as cybersecurity is.

An inseparable character of this play is malware. Let us motivate this thesis by listing several examples.

Firstly, one of the most prevalent malicious software is \emph{ransomware}. Its overall damage is estimated to be $\$20$ billion, increasing every year \cite{purplesec2021}, though the social impact might be arguably even more significant than the financial side as there have been attacks targetting even healthcare organizations which is further exacerbated by the fact that a first death following a ransomware attack was reported in 2020 \cite{Cimpanu2020}.

We can conclude that IoT malware is becoming more common, which is supportedd by Sonic Wall's 2019 report. This is caused by the insufficient protection of these small devices, for which we cannot provide complete malware protection. However, 127 new IoT devices are being connected to the internet every second which leads us to an estimation that by the end of 2021, there are going to be 35 billion IoT devices connected to the internet \cite{TheIoTRu52:online}. This risk can not be mitigated easily, and malware elimination will play an even more significant role as it has so far.

Another convenient trend for malware is widespread encryption, which has become a standard in web traffic. Its main goal is the security of information. Taking this fact into consideration, the creators of malware have a lot to hide and secure from the protectors as well. The encryption might inform us that the source has something that nobody else should see. A long-lasting trend of such behaviour might be suspicious. We can check if there is a justified reason to encrypt the data, or we can at least make some conclusions about the source of encrypted data. Nevertheless, that is not possible in the world where everything is encrypted.

In 2020, 94\% of malware was delivered by email \cite{Topcyber13:online} and therefore the importance of phishing emails with malicious attachments and other social engineering techniques grows. It is cheaper to produce one sophisticated, convincing email to retrieve some information than an attempt to attack a highly protected network perimeter. It also might be used to distribute malware or other threats.

In 2020 AV-atlas \cite{AVATLASM39:online} recorded over 750 million malware samples and moreover at the end of April 2021 this number has increased to over 820 million malware samples. The majority of them are executable files attacking Windows devices.

Malware research continues, and it will undoubtedly do so until we can introduce a sufficiently universal and flexible solution which will be able to detect zero-day threats (unseen). We might find a solution among machine learning models, which are often involved. However, its challenge is interpretability and explainability, not only in cybersecurity. We face the problem that a model's performance is often significant, but we are not sure why. It is risky to deploy such a model to a situation where it can meet unseen data. High-quality security engineers do not have to be high-quality machine learning engineers. If we want to involve machine learning methods increasingly, we need to interpret and explain its predictions. Then we can combine the knowledge of cybersecurity with the results of the models and gain a better understanding. 


\section*{Goal}
The main objective of this thesis is to design a pipeline that has a malware file dataset as the input and a machine learning model and its explanation as the output. We want to go through the whole process, document each step, and report results. Our acquisition is the process itself. It is described in detail for the reader to identify the problems we experienced and be able to replicate or extend our setup.

From the assignment of this thesis, we can extract the following steps:
\begin{enumerate}
    \itemsep0em 
    \item Run several instances of \emph{CAPEv2} \cite{Cape} sandbox and solve their orchestration for this experiment
    \item Capture the behaviour of selected malware samples and store the results
    \item Learn the hierarchical multiple instance learning (\emph{HMill}) framework
    \item Analyze the captured data. Report the basic statistics and choose appropriate features and hidden states for further modelling
    \item Using HMill, create models and identify the artefacts corresponding to different malware behaviour, and report the results
    \item Investigate which parts of the \emph{CAPEv2} log are important to different malware behaviour
\end{enumerate}
\subsection*{In detail}
The first step implies using dynamic malware analysis to retrieve the input for our machine learning model. This intention originated after we downloaded a couple of thousands of sandbox \emph{JSON} reports from the internet and examined. We observed that this use case might be challenging for our method and we might demostrate its capabilities on it.

The initial task is data collection. We are about to use MalwareBazaar\footnote{https://bazaar.abuse.ch/} as a public data source of malware samples. We chose it because of its free access with no claims for usage and a reasonable amount of samples. We aim at \emph{Portable Executable} (PE), which does not require any additional software running on the target machine. The sandbox we want to use is \emph{CAPEv2} \cite{Cape} because the first reports were also produced by this tool, and they are sufficient for analysis purposes.  It is a fork of a popular \emph{Cuckoo} sandbox which is no longer maintained. We need to deal with a distributed run of the sandbox to be able to collect a sufficient number of samples.

The model we want to use is a \emph{hierarchical multiple instance learning} model. In \cite{Mandlik2020}, the authors showed that this model has significant performance modelling \emph{JSON} documents. We describe it and its alternatives in the first part of the thesis. 

After further research, we decided to model the dependence of malware \emph{signatures} on behavioural features, both included in \emph{JSON} report. Signatures are the essential input for the original classification techniques used by the sandbox, and we want to see how well the model predicts them based on malware behaviour.

Finally, we will attempt to explain the predictions by choosing a minimal subset of features that contributes to the model prediction the most. The explanation will be performed using the existing \emph{HMill} explainer. We can study the implementation of signatures and their true cause, which might help us with results evaluation.

\section*{Thesis structure}
The thesis is divided into two main parts. In the first part, we focus on the theoretical background of our method. In the second part, we present a specific setup, our results, and their discussion. More complex structures (images, tables) are part of the appendices. The attachments containing additional material are described in \ref{app:attach}.

The theoretical part starts with the malware analysis theory in chapter \ref{chap:analysis} where we break down the malware itself, the types of its analyses, and its output. We continue in the chapter \ref{chap:classification} where we describe the machine learning formalism, cybersecurity context, and structured data (\emph{JSON} document) usage in machine learning. Finally, the chapters \ref{chap:hmill} and \ref{chap:expth} describe the particular methods used in our modelling and explaining experiments.

The second part consists of two chapters. Chapter \ref{chap:infrastructure} includes a description of the infrastructure and data collection process. Chapter \ref{chap:results} presents the model and explainer setup, results, and their discussion.




% The second part breaks down the use case we have. The first chapter \ref{chap:infrastructure} describes malware analysis sample collection, infrastructure and tools used to do that. Following two chapters contain description of the data and reasoning on how to use it and description of training process - hyperparameters, different models, conditions. Finally, last chapter is \ref{chap:expex} where we summarize the model explanation and its results. Crux of the thesis is the dicussion in the chapters \ref{chap:models} and \ref{chap:expex}where we address the model performance and explanation achievements and problems. We follow this discussion in the conlusion and in the formulation of goals of future work.


% The subject of this thesis is malware classification which is part of threat/intrusion detection. We want to use specific machine learning tool - \emph{hierarchical multiple instance learning} to train classifier on the data which we collect ourselves using dynamic malware analysis (\emph{sandboxing}). Our goal is to use data in \emph{JSON} format because this format is quite common output of reporting modules of sandboxes and usualy include majority of the information in structured form. The other reason is that the framework we are about to use shows significant results using such data.

% After we train the classifier (or several) we measure its performance and explain its predicitons. By explanation of predicition we mean using statistical method to extract the most important parts of input vector which contributed the most compared to other parts. Finally we discuss the performance of classifiers and the output of explanation.

% The model could be used to detect malicious code execution based on its behavior and later the explanation can be used to generalize some of our deterministic ways to detect malware (family assignment, signature marking) or just to explain what is for some specific malware family some generic group of malicious programs.

% There are experiments in each part of our task but we would like to examine the whole pipeline to see if we are able to go from plain malware sample to predictor which is explainable. We do not aspire to dig deep in some specific part rather we want to connect each step and identify problems which are in the whole process. We want to see it from a greater prespective. The whole process itself is acquisition and we want to demostrate all the steps.
% \todo{We can add some references}
% \section{Goals}




%%---------------------------------------------------------
% The structure of this thesis follows the steps which we defined in assignement but we solve theoretical point of view and our use case into two parts of this thesis.
% Text is organized such that each chapter focuses on specific goal from the assignement. Firstly we describe theory and prior work, further our conditions, experiments and conclusions.

% The main goal of this thesis which we are aiming at is to capture and analyze artifacts of dynamic malware analyses and draw conclusions in each part of the process. 

% - motivation
% - Motivation behind the modelling itself (classifying itself)
%   - classifying accordig to dynamic analyses, prior arts....
%   - My thesis is more practical, so the main goal is not to compare my results to another ones, but just demonstrate acuuracy of such classifier and everything around like for instance sandboxing, exaplaining
% - goals
% - structure of the thesis
