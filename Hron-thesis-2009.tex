\documentclass[11pt,twoside,a4paper]{book}
\usepackage[english]{babel}
\usepackage[T1]{fontenc} 				% pouzije EC fonty
\usepackage[utf8]{inputenc} 			% utf8 kódování vstupu 
\usepackage[square, numbers]{natbib}	% sazba pouzite literatury
\usepackage{fancyhdr}					% tisk hlaviček a patiček stránek
% \usepackage{nomencl} 					% umožňuje snadno definovat zkratky a jejich seznam
\usepackage[acronym]{glossaries}

\usepackage{charter}					% font
\usepackage{pdfpages}					% inserting pdfs
% \usepackage[chapter]{easy-todo}
% \usepackage{todonotes}
\usepackage{pgfplots}
\usepackage{dirtytalk}
\usepackage{amsfonts}
\usepackage{amsmath}
\usepackage{bbm}
\usepackage{subcaption}
\usepackage{algorithm}
\usepackage{multirow}
\usepackage{listings}
\usepackage{xcolor}
\usepackage{pgf-pie}
\usepackage{xcolor}
\usepackage{neuralnetwork}

%not tested
% \usepackage{fancyvrb}


\setlength\parindent{0pt}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% informace o práci
\newcommand\WorkTitle{Analyzing the execution of malware in a sandbox using hierarchical multiple instance learning}
\newcommand\FirstandFamilyName{Bc. Dominik Kouba}
\newcommand\Supervisor{doc. Ing. Tomáš Pevný, Ph.D.}
\newcommand\TypeOfWork{Master's Thesis}		
\newcommand\StudProgram{Open Informatics}
\newcommand\StudBranch{Cyber security}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% imports
\usepackage{graphicx}					% pro vkládání obrázků
\usepackage{k336_thesis_macros} 		% specialni makra pro formatovani DP a BP
\usepackage[
pdftitle={\WorkTitle},				% nastaví v informacích o pdf název
pdfauthor={\FirstandFamilyName},	% nastaví v informacích o pdf autora
colorlinks=true,					% před tiskem doporučujeme nastavit na false, aby odkazy a url nebyly šedé při ČB tisku
breaklinks=true,
urlcolor=red,
citecolor=black,
linkcolor=black,
unicode=true,
]
{hyperref}								% pro zobrazování "prokliknutelných" linků 

% rozšiřující importy
\usepackage{listings} 			%slouží pro tisk zdrojových kódů se syntax higlighting
\usepackage{algorithmicx} 		%slouží pro zápis algoritmů
\usepackage{algpseudocode} 		%slouží pro výpis pseudokódu
\usepackage{enumitem}
\usepackage{booktabs}

\newlist{abbrv}{itemize}{1}
\setlist[abbrv,1]{label=,labelwidth=1in,align=parleft,itemsep=0.1\baselineskip,leftmargin=!}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% příkazy šablony
\let\oldUrl\url				% url adresy budou zobrazeny: <url> 
\renewcommand\url[1]{<\texttt{\oldUrl{#1}}>}
\newtheorem{definition}{Definition}
\newcommand\todo[1]{\textcolor{red}{#1}}

\colorlet{punct}{red!60!black}
\definecolor{background}{HTML}{EEEEEE}
\definecolor{delim}{RGB}{20,105,176}
\definecolor{xblue}{rgb}{0.0, 0.0, 1.0}
\definecolor{xred}{rgb}{0.82, 0.1, 0.26}
\definecolor{xgreen}{rgb}{0.0, 0.5, 0.0}
\colorlet{numb}{magenta!60!black}

\lstdefinelanguage{json}{
    basicstyle=\normalfont\ttfamily,
    numbersep=8pt,
    showstringspaces=false,
    breaklines=true,
    frame=lines,
    backgroundcolor=\color{background},
    literate=
     *{0}{{{\color{numb}0}}}{1}
      {1}{{{\color{numb}1}}}{1}
      {2}{{{\color{numb}2}}}{1}
      {3}{{{\color{numb}3}}}{1}
      {4}{{{\color{numb}4}}}{1}
      {5}{{{\color{numb}5}}}{1}
      {6}{{{\color{numb}6}}}{1}
      {7}{{{\color{numb}7}}}{1}
      {8}{{{\color{numb}8}}}{1}
      {9}{{{\color{numb}9}}}{1}
      {:}{{{\color{punct}{:}}}}{1}
      {,}{{{\color{punct}{,}}}}{1}
      {\{}{{{\color{delim}{\{}}}}{1}
      {\}}{{{\color{delim}{\}}}}}{1}
      {[}{{{\color{delim}{[}}}}{1}
      {]}{{{\color{delim}{]}}}}{1},
}

\lstdefinelanguage{mypython}{
  language     = Python,
  basicstyle=\normalfont\ttfamily,
  numbersep=8pt,
  showstringspaces=false,
  breaklines=true,
  frame=lines,
  backgroundcolor=\color{background},
  keywordstyle=\color{xblue},
  emph={MyClass,__init__},
  emphstyle=\color{xred},
  stringstyle=\color{xgreen},
  literate=
   *{0}{{{\color{numb}0}}}{1}
	{1}{{{\color{numb}1}}}{1}
	{2}{{{\color{numb}2}}}{1}
	{3}{{{\color{numb}3}}}{1}
	{4}{{{\color{numb}4}}}{1}
	{5}{{{\color{numb}5}}}{1}
	{6}{{{\color{numb}6}}}{1}
	{7}{{{\color{numb}7}}}{1}
	{8}{{{\color{numb}8}}}{1}
	{9}{{{\color{numb}9}}}{1}
	{:}{{{\color{punct}{:}}}}{1}
	{,}{{{\color{punct}{,}}}}{1}
	{\{}{{{\color{delim}{\{}}}}{1}
	{\}}{{{\color{delim}{\}}}}}{1}
	{[}{{{\color{delim}{[}}}}{1}
	{]}{{{\color{delim}{]}}}}{1},
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% vlastní dokument
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}
	\selectlanguage{english}
	\translate

	% Assignment
	{
		\includepdf[pages=-]{pdfs/zadani.pdf}
		\newpage
	}

	% Title page 
	\coverpagestarts

	% Acknowledgements 
	\acknowledgements
	\noindent
	My deepest gratitude goes to my supervisor doc.~Ing.~Tomáš Pevný,~Ph.D. for giving me advice and helping me overcome struggles during this journey. I also sincerely thank to doc.~Mgr.~Branislav Bošanský,~Ph.D., Ing.~Thorsten Sick and Ing. Josef Liška for their advice and encouragement. Finally, I wish to extend my special thanks to my family.

	\noindent\rule{\textwidth}{0.4pt}

	\noindent Computational resources were supplied by the project "e-Infrastruktura CZ" (e-INFRA LM2018140) provided within the program Projects of Large Research, Development and Innovations Infrastructures. This support was very beneficial.


	% Declaration 
	\declaration{In Prague on May 15, 2021}

 	%Abstract 
	\abstractpage
The goal of the thesis was to perform dynamic malware analysis of portable executable files and create a dataset of analysis reports. Further, we aimed at statistical modelling of collected data and evaluation of models. Lastly, we intended to explain the model's predictions using statistical methods and discuss the result. We used \emph{CAPEv2} sandbox for malware analysis and implemented a pipeline that downloads malware samples, distributes them among multiple sandbox instances and collects results. We used \emph{JSON} report as the input to the modelling part. We decided to model the dependency of malware signatures on behavioural features like API calls, dropped files and processes. The causality of signatures is transparent because their Python implementation can be examined. That is convenient for further model and explanation evaluation. We used \emph{HMill} framework, which can model tree-structured data like \emph{JSON} documents. The structure of the data is involved in the model, not only extracted values. \emph{HMll} framework has better scalability than alternatives. For model explaining, we used \emph{HMill Explainer}. Its method is based on a minimal subtree selection problem using \emph{Banzaf} values as a subtree evaluation metric. We collected $80000$ malware analysis samples, from which we extracted \emph{JSON} reports. A binary classifier was trained for each of chosen signatures in the data set. Based on the type of signature, the classifiers have different performance, but nine out of twelve shows results above 90\% of balanced accuracy. We examined the implementation of each signature to see its actual cause in the report. Reported accuracy shows that the model can generalize even in more complex situations than we expected. Original behavioural reports used as features might have even hundreds of entries. However, the explainer provided $3-5$ entries as an explanation for each of the nine models. Our observation evidence that some models strongly involve the original signature's cause. There are cases where the model used different behavioural features with high accuracy. The realization of the whole pipeline from a malware sample to model and its explanation was successful. We reported and discussed all results. We also mention particular issues which we faced and ideas for future work. All programs are part of the attachment of the thesis. \
	
	\vspace{5mm}

	\noindent Keywords: \emph{Multilple instance learning, cybersecurity, malware}

	\let\cleardoublepage\clearpage

	\noindent
	\chapter*{Abstrakt}
	\noindent
The goal of the thesis was to perform dynamic malware analysis of portable executable files and create a dataset of analysis reports. Further, we aimed at statistical modelling of collected data and evaluation of models. Lastly, we intended to explain the model's predictions using statistical methods and discuss the result. We used \emph{CAPEv2} sandbox for malware analysis and implemented a pipeline that downloads malware samples, distributes them among multiple sandbox instances and collects results. We used \emph{JSON} report as the input to the modelling part. We decided to model the dependency of malware signatures on behavioural features like API calls, dropped files and processes. The causality of signatures is transparent because their Python implementation can be examined. That is convenient for further model and explanation evaluation. We used \emph{HMill} framework, which can model tree-structured data like \emph{JSON} documents. The structure of the data is involved in the model, not only extracted values. \emph{HMll} framework has better scalability than alternatives. For model explaining, we used \emph{HMill Explainer}. Its method is based on a minimal subtree selection problem using \emph{Banzaf} values as a subtree evaluation metric. We collected $80000$ malware analysis samples, from which we extracted \emph{JSON} reports. A binary classifier was trained for each of chosen signatures in the data set. Based on the type of signature, the classifiers have different performance, but nine out of twelve shows results above 90\% of balanced accuracy. We examined the implementation of each signature to see its actual cause in the report. Reported accuracy shows that the model can generalize even in more complex situations than we expected. Original behavioural reports used as features might have even hundreds of entries. However, the explainer provided $3-5$ entries as an explanation for each of the nine models. Our observation evidence that some models strongly involve the original signature's cause. There are cases where the model used different behavioural features with high accuracy. The realization of the whole pipeline from a malware sample to model and its explanation was successful. We reported and discussed all results. We also mention particular issues which we faced and ideas for future work. All programs are part of the attachment of the thesis.

	\vspace{5mm}

	\noindent Keywords: \emph{Multiinstanční hierarchické učení, kyberbezpečnost, malware}

	%%%%%%%%%%%%%%%%%%%%%%%%%%    
	% obsahy a seznamy
	\tableofcontents		% Obsah / Table of Contents 

	% pokud v práci nejsou obrázky nebo tabulky - odstraňte jejich seznam
	\listoffigures			% Obsah / Table of Contents 
	\listoftables			% Seznam tabulek / List of Tables

	%%%%%%%%%%%%%%%%%%%%%%%%%% 
	% TEXT
	\mainbodystarts

	%Chapters
	\part{Theory and prior}
	\include{chapters/introduction.tex}
	\include{chapters/analysis.tex}
	\include{chapters/classification.tex}
	\include{chapters/hmill.tex}
	\include{chapters/explain_theory.tex}

	\part{Experiments}
	\include{chapters/infrastructure.tex}
	\include{chapters/results.tex}
	%\include{chapters/conclusion.tex}
	
	%just to play with latex
	%\include{chapters/sandbox.tex}
	

	%%%%%%%%%%%%%%%%%%%%%%%%%% 
	% APPENDIX
	\appendix
	\include{chapters/apendices/cape.tex}
	\include{chapters/apendices/network.tex}
	\include{chapters/apendices/signatures.tex}
	\include{chapters/apendices/models.tex}
	\include{chapters/apendices/explanations.tex}
	\include{chapters/apendices/stack.tex}
	\include{chapters/apendices/attachments.tex}
	\include{chapters/acronyms.tex}
	%Biblio
	% \bibliographystyle{alpha}
	% \bibliographystyle{csplainnat}
	% bibliographystyle{plain}
	% \bibliographystyle{psc}
	% \bibliographystyle{apalike}
	\bibliographystyle{abbrv}
	{
	\bibliography{bib/Master_thesis}
	}

	% \chapter{Obsah přiloženého CD}
	% \textbf{\large Tato příloha je povinná pro každou práci. Každá práce musí totiž obsahovat přiložené CD. Viz dále.}

	% Může vypadat například takto. Váš seznam samozřejmě bude odpovídat typu vaší práce. (viz \cite{infodp}):

	% \begin{figure}[h]
	% \begin{center}
	% \includegraphics[width=14cm]{figures/seznamcd}
	% \caption{Seznam přiloženého CD --- příklad}
	% \label{fig:seznamcd}
	% \end{center}
	% \end{figure}

	% Na GNU/Linuxu si strukturu přiloženého CD můžete snadno vyrobit příkazem:\\ 
	% \verb|$ tree . >tree.txt|\\
	% Ve vzniklém souboru pak stačí pouze doplnit komentáře.

	% Z \textbf{README.TXT} (případne index.html apod.)  musí být rovněž zřejmé, jak programy instalovat, spouštět a jaké požadavky mají tyto programy na hardware.

	% Adresář \textbf{text}  musí obsahovat soubor s vlastním textem práce v PDF nebo PS formátu, který bude později použit pro prezentaci diplomové práce na WWW.

\end{document}
